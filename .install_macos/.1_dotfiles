#!/usr/bin/env bash

# File based on mathiasbynens and kentcdodds .macos files!
# mathiasbynens â€” https://github.com/mathiasbynens/dotfiles/blob/master/.macos
# kentcdodds â€” https://github.com/kentcdodds/dotfiles/blob/master/.macos

# Run without downloading:
# curl https://raw.githubusercontent.com/teziovsky/dotfiles/main/.install_macos/.1_dotfiles | bash
# Close any open System Preferences panes, to prevent them from overriding
# settings weâ€™re about to change
osascript -e 'tell application "System Preferences" to quit'

# Ask for the administrator password upfront
sudo -v

# Keep-alive: update existing `sudo` time stamp until `.1_dotfiles` has finished
while true; do sudo -n true; sleep 60; kill -0 "$$" || exit; done 2>/dev/null &

###############################################################################
# Tezivosky's Customizations                                                  #
###############################################################################

echo -e "\n\n"
echo -e "##########################################"
echo -e "\nHello $(whoami)! Let's set up your dotfiles! ðŸ”¥\n"
echo -e "##########################################"

echo -e "\n"
echo -e "Generating SSH Keys"
echo -e "--------------------------------"

SSH_GITHUB_FILE=~/.ssh/id_github
if ! [ -f "$SSH_GITHUB_FILE" ]; then
    ssh-keygen -t ed25519 -b 4096 -C "teziovsky@gmail.com" -f "$SSH_GITHUB_FILE"
    eval "$(ssh-agent -s)"
    ssh-add --apple-use-keychain "$SSH_GITHUB_FILE"
    echo -e "SSH Key - generated ðŸ”¥"
else
    echo -e "SSH Key - already exists! ðŸ‘Œ"
fi

echo -e "\n"
echo -e "Adding SSH Key to ssh-agent..."
echo -e "--------------------------------"

SSH_CONFIG_FILE=~/.ssh/config
SSH_GITHUB_HOST="Host github.com\n  AddKeysToAgent yes\n  UseKeychain yes\n  IdentityFile $SSH_GITHUB_FILE"

if ! [ -f "$SSH_CONFIG_FILE" ]; then
    touch "$SSH_CONFIG_FILE"
    echo -e "SSH config file - created ðŸ”¥"

    echo -e "$SSH_GITHUB_HOST" >> "$SSH_CONFIG_FILE"
    echo -e "Github Host SSH Config - added ðŸ”¥"
else
    echo -e "SSH config file - already exists! ðŸ‘Œ"

    if ! grep -q "Host github.com" $SSH_CONFIG_FILE; then
        echo -e "\n$SSH_GITHUB_HOST" >> "$SSH_CONFIG_FILE"
        echo -e "Github Host SSH Config - added ðŸ”¥"
    else
        echo -e "Github Host SSH Config - already exists! ðŸ‘Œ"
    fi
fi

echo -e "\n"
read -p "Do you want to add SSH Key to Github? (Y/n): " WANT_ADD_SSH_TO_GITHUB
echo -e "--------------------------------"
if [[ -z $WANT_ADD_SSH_TO_GITHUB || $WANT_ADD_SSH_TO_GITHUB == "y" || $WANT_ADD_SSH_TO_GITHUB == "Y" ]]; then
    open https://github.com/settings/ssh/new
    sleep 5
    read -p "Press enter to continue..."
    echo -e "SSH Key added ðŸ”¥"
fi

echo -e "\n"
echo -e "Cloning dotfiles..."
echo -e "--------------------------------"
if [ ! -d ~/.dotfiles ]; then
    git clone --bare git@github.com:teziovsky/dotfiles.git "$HOME"/.dotfiles
    alias dotfiles="/usr/bin/git --git-dir=$HOME/.dotfiles/ --work-tree=$HOME"
    dotfiles config --local status.showUntrackedFiles no
    dotfiles checkout -f
    source ~/.zshrc
    echo -e "Dotfiles - installed ðŸ”¥"
else
    echo -e "Dotfiles - already exists! ðŸ‘Œ"
fi
